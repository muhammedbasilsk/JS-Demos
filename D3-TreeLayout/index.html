<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node circle {
  fill: #fff;
  stroke: yellow;
  stroke-width: .5px;
}

.node {
  font: 10px sans-serif;
}
circle{
   fill: none;
   stroke:white;
   stroke-width: 1.5px;
}

.link{
  fill: none;
  stroke:green;
  stroke-width: 1.5px;
}
body{
  background-color: black;
}
.ui-slider-vertical .ui-slider-handle{
  width: 17px !important;
}
.ui-widget-content {
  width: 10px !important;
}
.tooltip_name{
 color: white;
}
</style>
<body>
<div id="viz"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.0/themes/base/jquery-ui.css" />
<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
<script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js"></script>
<script>

var diameter = 720;

var tree = d3.layout.tree()
      .size([360, diameter / 2 - 120])
      .separation(function(a, b) { 
	  return (a.parent == b.parent ? 1 : 3) / a.depth; 
      });
var diagonal = d3.svg.diagonal.radial()
      .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });
 
var svg = d3.select("#viz").append("svg")
      .call(d3.behavior.zoom().on("zoom", zoomAndPan)
      .scaleExtent([0.5,4]))
      .attr("width", "100%")
      .attr("height", "100%")
      .append("g")
      .attr("transform", "translate("+ diameter / 2 + "," + diameter / 2 +")");

d3.json("flare.json", function(error, root) {
  var nodes = tree.nodes(root),
      links = tree.links(nodes);
  var hash = {};
  nodes.filter(function(d){ hash[d.depth] =  d.y; });
  $.each(hash,function(key,val){
      svg.append("path")
	.attr("d","M0,"+val+"A"+val+","+val+" 0 1,1 0,-"+val+"A"+val+","+val+" 0 1,1 0,"+val+"Z")
	.style("stroke", "#fff")
	.style("fill", "transparent");
  });
  var link = svg.selectAll(".link")
      .data(links)
      .enter().append("path")
      .attr("source", function(d) {return d.source.name;})
      .attr("target", function(d) { return d.target.name ;})
      .attr("class", "link")
      .attr("id",function(d){ return "link_"+ d.source.name + d.target.name; })
      .attr("opacity",1e-6)
      .attr("d", diagonal);

  var node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("id", function(d, id){ return d.name; })
      .attr("class", "node")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
      .on("mouseover",  nodeMouseover)
      .on("click",  nodeMouseClick)
      .on("dblclick",  nodeMouseDblClick)
      .on("mouseout", nodeMouseout);
  node.append("circle")
      .attr("r", 4.5)
      .attr("id", function(d, id){ return "cid"+d.name; })
      .attr("opacity",1e-6)
      .each(appear());
  
  d3.select('#viz')
      .append('div')
      .attr('id','tooltip')
      .style('position', 	'absolute')
      .style('height', 		'200px')
      .style('left', 		'1000px')
      .style('top','405px')
      .style('border','1px solid grey')
      .style('width','300px')
      .style('opacity',0);

function appear() {
    return function(d, i, j) {
      d.pending = 1; 
        d3.select(this).transition()
          .duration(150)
          .delay(d.depth*300)
          .attr("opacity", 1)
          .each("end", function(d, idx) {
             d.pending = 0;
             var neighbors;
             $(links).each(function(a, lnk, b) {
               if ((lnk.source == d || lnk.target == d) && !lnk.source.pending && !lnk.target.pending) {
                 d3.select("#link_"+ lnk.source.name + lnk.target.name).transition()
                     .duration(150)
                     .attr("opacity", 1);
               }
             });
          });
    };
  }
});
function zoomAndPan() {
  svg.attr("transform", "translate(" + d3.event.translate + ")"+ " scale(" + d3.event.scale + ")");
}
function nodeMouseover(d) {
 console.log("in mouse over");
  if(d3.select('#tooltip')[0][0].firstChild)
  	d3.select('#tooltip')[0][0].firstChild.remove();
  d3.select('#tooltip').style("opacity",1);
  d3.select('#tooltip')
	.append("p")
	.text(d.name)
	.attr("class","tooltip_name");
  d3.select(this)
	.select("circle")
	.transition()
	.duration(250)
	.attr("r", 8);
}
function nodeMouseout() {
  d3.select('#tooltip').style("opacity",0)
  d3.select(this)
	.select("circle")
	.transition()
	.duration(250)
	.attr("r", 4.5 );
}
function nodeMouseDblClick(d){
	var allNodes = d3.selectAll('circle');
	var allLinks = d3.selectAll('path');
	$.each(allNodes[0],function(){
	       $(this).attr('style','opacity:1')
	});
	$.each(allLinks[0],function(){
	       $(this).attr('style','opacity:1')
	});
	d3.event.preventDefault();
}
function getParents(d){
 if (d.parent != null && d.name !== d.parent.name) {
      return [ d.parent].concat(getParents(d.parent));
 } else {
    return [];
 }
}
function getChildren(d){
 if(d.children != null){
 $.each(d.children,function(key,child){ 
	return [child].concat(getChildren(child)); 
	})
 }
}
function nodeMouseClick(d){
   var allNodes = d3.selectAll('circle');
       var allLinks = d3.selectAll('path');
       $.each(allNodes[0],function(){
               $(this).attr('style','opacity:0')
       });
       $.each(allLinks[0],function(){
               $(this).attr('style','opacity:0')
       });
       var nod = d;
       child_recurr(nod);
       parent_recurr(nod);
       $('#cid'+$(nod).attr('name')).css("opacity","1");
       function child_recurr(nod){
               if(!nod.children)
                       return false;
               $.each(nod.children,function(){
                       var id = $(this).attr('name');
                       $('#cid'+$(this).attr('name')).css("opacity","1");
                       $.each(allLinks[0],function(){
                               if($(this).attr('source')==id || $(this).attr('target')==id)
                                       $(this).attr('style','opacity:1')
                       });
                       if(this.children)
                               child_recurr(this);
               });
       }
       function parent_recurr(nod){
                       $('#cid'+$(nod.parent).attr('name')).css("opacity","1");
                       var id = $(nod).attr('name');
                       $.each(allLinks[0],function(){
                               if($(this).attr('target')==id)
                                       $(this).attr('style','opacity:1')
                       });
                       if(nod.parent)
                               parent_recurr(nod.parent);
       }
       d3.event.preventDefault();
}
function getMyNode(id){
        var data;
	$.each(d3.selectAll(".node")[0],function(k,d){ 
		if (d.id == id){
			data = d;
			return false;
		}
	});
	return data;
}
d3.select(self.frameElement).style("height", diameter - 150 + "px");
</script>
